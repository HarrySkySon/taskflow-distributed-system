<a name="лабораторна-робота-8"></a><a name="звіт"></a><a name="лабораторна-робота-5"></a>**КИЇВСЬКИЙ НАЦІОНАЛЬНИЙ УНІВЕРСИТЕТ\
БУДІВНИЦТВА ТА АРХІТЕКТУРИ**\
\
\
Кафедра інформаційних технологій\
\
\
\
\
\
**ЛАБОРАТОРНА РОБОТА 8**\
\
з дисципліни

\
**"Архітектура розподілених програмних систем"**\
\
на тему:\
\
**" Моніторинг та логування розподілених систем "**\
\
\

**\
\
\
\
\


Виконав: студент групи ІПЗм(д)-25\
Постановський Ігор Анатолійович\
\
Перевірив: Мазуренко Р.В.

Київ – 2025
# **Звіт з лабораторної роботи №8**
<a name="аналіз-вимог-до-розподіленої-системи"></a>**Дисципліна:** Архітектура розподілених програмних систем 

**Тема:** Моніторинг та логування розподілених систем
### <a name="xd5c4d9fe1a5ab5d466002c0dbf8ba6a7cd67b15"></a><a name="мета-роботи"></a>**МЕТА РОБОТИ**
Навчитися реалізовувати комплексне спостереження за розподіленими мікросервісними системами через збір метрик, логів та трасування для забезпечення видимості, діагностики та оптимізації продуктивності.
### <a name="завдання"></a>**Завдання**
1. Розуміти три стовпи спостережуваності (metrics, logs, traces)
1. Налаштувати збір метрик з використанням Prometheus
1. Реалізувати custom metrics у мікросервісах
1. Создать Grafana dashboards для візуалізації метрик
1. Налаштувати агрегацію логів з Loki та Promtail
1. Інструментувати Node.js сервіси з prom-client
1. Протестувати систему моніторингу та логування
1. Задокументувати процес конфігурації та експлуатації
### <a name="предметна-область"></a>**Предметна область**
**TaskFlow - Project Management System** Розподілена система управління проектами з моніторингом та логуванням всіх компонентів.
##
## <a name="x5c8bc0bf79c4086ccda5ad5b2e865f377fa89dc"></a>**2. Теоретичні відомості**
### <a name="xe67da5f6353ef3e80586de6a8f2c730d0eeb7a1"></a>**2.1 Спостережуваність (Observability)**
**Спостережуваність** - це здатність зрозуміти внутрішній стан системи через аналіз їх зовнішніх результатів.

На відміну від традиційного **моніторингу** (перевірка заздалегідь відомих метрик), спостережуваність дозволяє дослідити будь-які питання щодо поведінки системи.
#### <a name="три-стовпи-спостережуваності"></a>*Три стовпи спостережуваності:*
##### <a name="x5a888089a98a116b5ed45ba30e8eacf41f6cace"></a>1. **Metrics (Метрики)**
Числові вимірювання системи в контексті часу.

**Типи метрик:**

- **Counter** - тільки збільшується (кількість запитів, помилок)
- **Gauge** - може рости і спадати (використання CPU, память)
- **Histogram** - розподіл значень (latency запитів)
- **Summary** - квантилі та суми (час обробки)

**Приклади:**

http\_requests\_total{method="GET", path="/api/projects"} 1523\
http\_request\_duration\_seconds{method="POST", le="0.1"} 432\
system\_memory\_bytes{type="resident"} 536870912
##### <a name="xe9ef4bbd764fe7c6cd23f226d3fe9f423368a9c"></a>2. **Logs (Логи)**
Дискретні записи про певні події в системі.

**Рівні логування:**

- DEBUG - детальна інформація для діагностики
- INFO - інформаційні повідомлення про нормальну роботу
- WARN - попередження про потенційні проблеми
- ERROR - помилки, які впливають на функціонал
- FATAL - критичні помилки, що призводять до краху

**Структуровані логи:**

{\
`  `"timestamp": "2024-02-15T10:30:45.123Z",\
`  `"level": "INFO",\
`  `"service": "projects-service",\
`  `"message": "Project created successfully",\
`  `"projectId": 42,\
`  `"userId": 7,\
`  `"duration\_ms": 156\
}
##### <a name="x7c06d65f938789316a234bab502a16618bd6556"></a>3. **Traces (Трасування)**
Послідовність подій та z’єднання між мікросервісами.

**Компоненти трасування:**

- **Trace ID** - унікальний ідентифікатор запиту через всю систему
- **Span ID** - окремий сегмент роботи у одному сервісі
- **Parent Span** - ієрархія викликів

**Приклад:**

Trace: 4bf92f3577b34da6a3ce929d0e0e4736\
├─ Span: client-request (0-10ms)\
│  └─ Span: projects-service (1-9ms)\
│     ├─ Span: database-query (2-5ms)\
│     └─ Span: rabbitmq-publish (6-8ms)\
└─ Span: notifications-service (5-10ms)
### <a name="xf54286ac1888d8d08e83d1f4080a7e47e446567"></a>**2.2 Prometheus**
**Prometheus** - це система моніторингу з часовими рядами, розроблена для моніторингу надійності та продуктивності систем.
#### <a name="архітектура-prometheus"></a>*Архітектура Prometheus:*
┌──────────────────────────────────────────────────┐\
│                   Prometheus                     │\
│                                                  │\
│  ┌─────────────────────────────────────────────┐ │\
│  │         TSDB (Time Series Database)         │ │\
│  │  (Зберігання всіх метрик з часовими мітками)│ │\
│  └─────────────────────────────────────────────┘ │\
│                       ▲                          │\
│                       │                          │\
│  ┌────────────────────┴────────────────────────┐ │\
│  │         Scraper (Pull Model)                │ │\
│  │  (Периодично витягує метрики з endpoints)   │ │\
│  └────────────────────┬────────────────────────┘ │\
└─────────────────────────┬────────────────────────┘\
`                          `│\
`                `┌─────────┴─────────┐\
`                `│                   │\
`          `┌─────▼──────┐    ┌──────▼──────┐\
`          `│   Service  │    │   Service   │\
`          `│  /metrics  │    │  /metrics   │\
`          `└────────────┘    └─────────────┘
#### <a name="переваги-pull-model"></a>*Переваги Pull Model:*
- Простота масштабування (додавати метрики, не змінюючи сервер) 
- Легка безпека (не потрібно надсилати дані назовні) 
- Контроль над частотою збирання (scrape interval) 
- Простіше відокремити мертві сервіси
#### <a name="конфігурація-prometheus"></a>*Конфігурація Prometheus:*
global**:**\
`  `scrape\_interval**:** 15s      *# Як часто збирати метрики*\
`  `evaluation\_interval**:** 15s  *# Як часто обчислювати правила*\
`  `external\_labels**:**\
`    `monitor**:** 'TaskFlow'\
\
scrape\_configs**:**\
`  `**-** job\_name**:** 'projects-service'\
`    `static\_configs**:**\
`      `**-** targets**:** **[**'projects-service:9090'**]**\
`    `scrape\_interval**:** 10s\
\
`  `**-** job\_name**:** 'notifications-service'\
`    `static\_configs**:**\
`      `**-** targets**:** **[**'notifications-service:9091'**]**\
\
`  `**-** job\_name**:** 'rabbitmq'\
`    `static\_configs**:**\
`      `**-** targets**:** **[**'rabbitmq:15692'**]**
### <a name="x09b7a3b3550b5b35adaf32dc52db032ce16e29b"></a>**2.3 PromQL - Prometheus Query Language**
**PromQL** - мова запитів для вибірки та агрегації даних часових рядів.
#### <a name="базові-операції"></a>*Базові операції:*
**1. Пошук метрик:**

http\_requests\_total                    # Вся метрика\
http\_requests\_total{method="GET"}      # З фільтром\
http\_requests\_total{job=~".\*service"}  # Regex фільтр

**2. Агрегація:**

sum(http\_requests\_total)               # Сума всіх запитів\
avg(http\_request\_duration\_seconds)     # Середня тривалість\
rate(http\_requests\_total[5m])          # Кількість запитів на секунду за 5 хвилин

**3. Складні запити:**

histogram\_quantile(0.95, http\_request\_duration\_seconds)  # 95-й перцентиль\
topk(5, sum by (path) (rate(http\_requests\_total[1m])))   # ТОП 5 шляхів за запитами
### <a name="x99d1deb7f56ccdbc4986d0d839893dda6fc6688"></a>**2.4 Grafana**
**Grafana** - платформа для візуалізації метрик та створення dashboards.
#### <a name="можливості"></a>*Можливості:*
- Підтримує різні джерела даних (Prometheus, Loki, InfluxDB, MySQL тощо) 
- Розширена бібліотека графіків та панелей 
- Шаблонні змінні для динамічних dashboards 
- Оповіщення (alerts) з різними каналами (email, Slack, Webhook) 
- Аннотації для позначення важливих подій
#### <a name="типи-панелей"></a>*Типи панелей:*
- **Graph** - лінійний графік часових рядів
- **Stat** - одне числове значення
- **Gauge** - круглий індикатор
- **Table** - таблиця даних
- **Heatmap** - тепла карта розподілу
- **Logs** - переглядач структурованих логів
### <a name="x715778d305807a8768c2c33d5d4dd525a0cd741"></a>**2.5 Loki - Log Aggregation**
**Loki** - легка система агрегації логів від Grafana, що працює на основі меток (labels), а не повного індексування.
#### <a name="архітектура-loki"></a>*Архітектура Loki:*
┌─────────────────────────────────────┐\
│      Promtail (Log Shipper)         │\
│  (Зчитує логи з контейнерів)        │\
└──────────────┬──────────────────────┘\
`               `│\
`               `▼\
┌─────────────────────────────────────┐\
│  Loki (Log Aggregation & Storage)   │\
│                                     │\
│  ├─ Distributor (прийом логів)      │\
│  ├─ Ingester (буферизація)          │\
│  └─ Querier (пошук та видача)       │\
└─────────────────────────────────────┘
#### <a name="переваги-loki"></a>*Переваги Loki:*
- Енергоефективна індексація через labels 
- Низька вартість зберігання 
- Інтеграція з Grafana 
- Легко масштабується
#### <a name="logql---loki-query-language"></a>*LogQL - Loki Query Language:*
{job="projects-service"} |= "error"          # Логи з помилками\
{job=~".\*service"} | json | status > 400      # JSON парсинг\
{service="api"} | logfmt | duration > 500     # Parsingу logfmt format
### <a name="xdd8b53d2374f62a7190123f2887f9e71f99e6ff"></a>**2.6 Promtail - Log Shipper**
**Promtail** - agent, що збирає логи з контейнерів та надсилає їх до Loki.
#### <a name="конфігурація"></a>*Конфігурація:*
clients**:**\
`  `**-** url**:** http://loki:3100/loki/api/v1/push\
\
scrape\_configs**:**\
`  `**-** job\_name**:** projects-service\
`    `docker\_sd\_configs**:**\
`      `**-** host**:** unix:///var/run/docker.sock\
`    `relabel\_configs**:**\
`      `**-** source\_labels**:** **[**\_\_meta\_docker\_container\_name**]**\
`        `target\_label**:** container\
`      `**-** source\_labels**:** **[**\_\_meta\_docker\_container\_log\_stream**]**\
`        `target\_label**:** stream
### <a name="xab35ce76938ed4546734aa40aeb8f2eabe73ba6"></a>**2.7 Instrumentation with prom-client**
**prom-client** - Node.js бібліотека для експорту метрик у форматі Prometheus.
#### <a name="основні-типи-метрик"></a>*Основні типи метрик:*
**import** promClient **from** 'prom-client';\
\
*// Counter - тільки збільшується*\
**const** httpRequestsTotal = **new** promClient.Counter({\
`  `name: 'http\_requests\_total',\
`  `help: 'Total number of HTTP requests',\
`  `labelNames: ['method', 'path', 'status']\
});\
\
*// Gauge - може рости і спадати*\
**const** systemMemoryBytes = **new** promClient.Gauge({\
`  `name: 'system\_memory\_bytes',\
`  `help: 'System memory usage in bytes',\
`  `labelNames: ['type']\
});\
\
*// Histogram - розподіл значень*\
**const** httpRequestDuration = **new** promClient.Histogram({\
`  `name: 'http\_request\_duration\_seconds',\
`  `help: 'HTTP request duration in seconds',\
`  `labelNames: ['method', 'path'],\
`  `buckets: [0.01, 0.05, 0.1, 0.5, 1, 2, 5]\
});\
\
*// Використання:*\
httpRequestsTotal.inc({ method: 'GET', path: '/api/projects', status: '200' });\
**const** timer = httpRequestDuration.startTimer();\
*// ... обробка запиту ...*\
timer({ method: 'GET', path: '/api/projects' });
##
## <a name="xaeb4eda15e00016e9ea9abcbe1b62322b90e1cf"></a>**3. Завдання згідно варіанту**
### <a name="x0fae7f4658ad2e0d690965d0bd9a9c91d850925"></a>**Предметна область: TaskFlow Project Management System**
### <a name="розширена-архітектура-системи"></a>**Розширена архітектура системи**
┌───────────────────────────────────────────────────────────────────┐\
│              Docker Compose - Розподілена система з моніторингом  │\
│                                                                   │\
│  ┌────────────────────────────────────────────────────────────┐   │\
│  │               Application Services                         │   │\
│  │                                                            │   │\
│  │  ┌──────────────────┐         ┌──────────────────────┐     │   │\
│  │  │  Projects Service│◄───────►│  Notifications Serv. │     │   │\
│  │  │  :4002 /metrics  │         │  :4004 /metrics      │     │   │\
│  │  └──────────┬───────┘         └────────────┬─────────┘     │   │\
│  │             │                              │               │   │\
│  │             ▼                              ▼               │   │\
│  │       ┌─────────────┐        ┌──────────────────────┐      │   │\
│  │       │ PostgreSQL  │        │   RabbitMQ           │      │   │\
│  │       │ :5432       │        │  :5672, :15692       │      │   │\
│  │       └─────────────┘        └──────────────────────┘      │   │\
│  └────────────────────────────────────────────────────────────┘   │\
│                           │                                       │\
│  ┌────────────────────────┼──────────────────────────────────┐    │\
│  │           Monitoring Stack                                │    │\
│  │                       │                                   │    │\
│  │  ┌────────────────────▼──────────────┐                    │    │\
│  │  │  Prometheus (:9090)               │                    │    │\
│  │  │  (Збір метрик Pull Model)         │                    │    │\
│  │  └────────────┬──────────────────────┘                    │    │\
│  │               │                                           │    │\
│  │  ┌────────────▼──────────────────┐  ┌────────────┐        │    │\
│  │  │  Grafana (:3000)              │  │  Loki      │        │    │\
│  │  │  (Dashboards, Visualizations) │  │  (:3100)   │        │    │\
│  │  └───────────────────────────────┘  │ (Logs)     │        │    │\
│  │                                     │            │        │    │\
│  │  ┌────────────────────────────────┐ ├────────────┤        │    │\
│  │  │  Promtail (:9080)              │ │  Reverse   │        │    │\
│  │  │  (Log Shipper)                 │ │  Proxy     │        │    │\
│  │  └────────────────────────────────┘ └────────────┘        │    │\
│  └───────────────────────────────────────────────────────────┘    │\
│                                                                   │\
│  Network: taskflow-network (bridge)                               │\
│  Volumes: prometheus\_data, grafana\_data, loki\_data                │\
└───────────────────────────────────────────────────────────────────┘
### <a name="компоненти-системи"></a>**Компоненти системи**
#### <a name="x9220799a8a31b7896c4db006ce43f1b12edcf8c"></a>*1. Projects Service + Prometheus Metrics*
- **Порт:** 4002 (API), 9090 (/metrics)
- **Метрики:** http\_requests\_total, http\_request\_duration\_seconds, events\_published\_total
- **Інструментація:** prom-client
#### <a name="x8d6c54861bdcfdd07f50f6071f31973930979c8"></a>*2. Notifications Service + Prometheus Metrics*
- **Порт:** 4004 (API), 9091 (/metrics)
- **Метрики:** events\_received\_total, events\_processed\_duration\_seconds
- **Інструментація:** prom-client
#### <a name="x3e4b4adb7fd6d58f91145e35b70c1b5657bd5e7"></a>*3. Prometheus*
- **Порт:** 9090
- **Функціонал:** Збір метрик від сервісів
- **Конфіг:** prometheus.yml
#### <a name="x400cf576cef3aa74d69ca69586ec7ca4ffe0a66"></a>*4. Grafana*
- **Порт:** 3000
- **Функціонал:** Візуалізація метрик та dashboards
- **Конфіг:** datasources.yml, dashboards.yml
#### <a name="x2323725ce349c8773aed0af71b5ecf46ef4b1e6"></a>*5. Loki*
- **Порт:** 3100
- **Функціонал:** Агрегація логів
- **Конфіг:** loki-config.yml
#### <a name="xfde775933a43a13b0b7c854296aeccc525af15b"></a>*6. Promtail*
- **Порт:** 9080
- **Функціонал:** Збір логів від контейнерів
- **Конфіг:** promtail-config.yml
### <a name="завдання-для-виконання"></a>**Завдання для виконання**
1. Додати Prometheus метрики до projects-service
1. Додати Prometheus метрики до notifications-service
1. Створити конфігурацію Prometheus (prometheus.yml)
1. Налаштувати Grafana з datasources та dashboards
1. Конфігурувати Loki для агрегації логів
1. Налаштувати Promtail для збору логів
1. Розширити docker-compose.yml з 4 моніторинг-сервісами
1. Протестувати систему моніторингу та логування
##
## <a name="xbe07798b59ea587a178358e2427d43e22858620"></a>**4. Хід виконання роботи**
### <a name="x82ccd5276ef3556b3045562412bdb028097a7e0"></a>**4.1 Додавання Prometheus метрик до Projects Service**
#### <a name="x099d492db80963def371a541d00369b91776101"></a>*4.1.1 Встановлення залежностей*
npm install prom-client\
npm install --save-dev @types/prom-client
#### <a name="x09bd0be5beae2bc8ff80c165e01d49857e995f8"></a>*4.1.2 Інструментація проекту*
**Файл: projects-service/src/metrics.ts**

**import** promClient **from** 'prom-client';\
\
*// Базові метрики*\
**export** **const** register = **new** promClient.Registry();\
\
*// Default metrics (процес, пам'ять, CPU)*\
promClient.collectDefaultMetrics({ register });\
\
*// Custom metrics*\
**export** **const** httpRequestsTotal = **new** promClient.Counter({\
`  `name: 'http\_requests\_total',\
`  `help: 'Total number of HTTP requests',\
`  `labelNames: ['method', 'path', 'status'],\
`  `registers: [register]\
});\
\
**export** **const** httpRequestDurationSeconds = **new** promClient.Histogram({\
`  `name: 'http\_request\_duration\_seconds',\
`  `help: 'HTTP request duration in seconds',\
`  `labelNames: ['method', 'path', 'status'],\
`  `buckets: [0.01, 0.05, 0.1, 0.5, 1, 2, 5],\
`  `registers: [register]\
});\
\
**export** **const** databaseQueryDurationSeconds = **new** promClient.Histogram({\
`  `name: 'database\_query\_duration\_seconds',\
`  `help: 'Database query duration in seconds',\
`  `labelNames: ['operation', 'table'],\
`  `buckets: [0.001, 0.005, 0.01, 0.05, 0.1, 0.5],\
`  `registers: [register]\
});\
\
**export** **const** eventsPublishedTotal = **new** promClient.Counter({\
`  `name: 'events\_published\_total',\
`  `help: 'Total number of events published to RabbitMQ',\
`  `labelNames: ['event\_type', 'status'],\
`  `registers: [register]\
});\
\
**export** **const** activeProjectsGauge = **new** promClient.Gauge({\
`  `name: 'active\_projects\_total',\
`  `help: 'Total number of active projects',\
`  `registers: [register]\
});

**Файл: projects-service/src/middleware/metrics.ts**

**import** { Request, Response, NextFunction } **from** 'express';\
**import** {\
`  `httpRequestsTotal,\
`  `httpRequestDurationSeconds\
} **from** '../metrics';\
\
**export** **const** metricsMiddleware = (\
`  `req: Request,\
`  `res: Response,\
`  `next: NextFunction\
) **=>** {\
`  `**const** startTime = Date.now();\
\
`  `res.on('finish', () **=>** {\
`    `**const** duration = (Date.now() - startTime) / 1000;\
`    `**const** path = req.path.replace(/[0-9]/g, ':id'); *// Нормалізація шляхів*\
\
`    `httpRequestsTotal.inc({\
`      `method: req.method,\
`      `path,\
`      `status: res.statusCode.toString()\
`    `});\
\
`    `httpRequestDurationSeconds.observe(\
`      `{ method: req.method, path, status: res.statusCode.toString() },\
`      `duration\
`    `);\
`  `});\
\
`  `next();\
};

**Файл: projects-service/src/app.ts**

**import** express **from** 'express';\
**import** { register } **from** './metrics';\
**import** { metricsMiddleware } **from** './middleware/metrics';\
\
**const** app = express();\
\
*// Middleware*\
app.use(metricsMiddleware);\
\
*// Prometheus metrics endpoint*\
app.get('/metrics', (req, res) **=>** {\
`  `res.set('Content-Type', register.contentType);\
`  `res.end(register.metrics());\
});\
\
*// Health endpoint*\
app.get('/health', (req, res) **=>** {\
`  `res.status(200).json({\
`    `success: **true**,\
`    `message: 'Projects Service is running',\
`    `timestamp: **new** Date().toISOString()\
`  `});\
});\
\
*// API endpoints...*
#### <a name="xc2a26aabaae2d75e3713c81c2334eae9563d7a0"></a>*4.1.3 Інструментація бізнес-логіки*
**Файл: projects-service/src/services/projectService.ts**

**import** {\
`  `databaseQueryDurationSeconds,\
`  `eventsPublishedTotal,\
`  `activeProjectsGauge\
} **from** '../metrics';\
\
**export** **class** ProjectService {\
`  `**async** createProject(data: CreateProjectDTO) {\
`    `**const** timer = databaseQueryDurationSeconds.startTimer();\
\
`    `**try** {\
`      `*// Створення проекту в БД*\
`      `**const** project = **await** db.projects.create(data);\
\
`      `timer({ operation: 'CREATE', table: 'projects' });\
\
`      `*// Публікація подій*\
`      `**await** **this**.publishEvent('project.created', project);\
`      `eventsPublishedTotal.inc({\
`        `event\_type: 'project.created',\
`        `status: 'success'\
`      `});\
\
`      `*// Оновлення лічильника активних проектів*\
`      `**await** **this**.updateActiveProjectsCount();\
\
`      `**return** project;\
`    `} **catch** (error) {\
`      `timer({ operation: 'CREATE', table: 'projects' });\
`      `eventsPublishedTotal.inc({\
`        `event\_type: 'project.created',\
`        `status: 'error'\
`      `});\
`      `**throw** error;\
`    `}\
`  `}\
\
`  `**private** **async** updateActiveProjectsCount() {\
`    `**const** count = **await** db.projects.count({\
`      `where: { status: 'active' }\
`    `});\
`    `activeProjectsGauge.set(count);\
`  `}\
}
### <a name="xf3ec00d87df597f91d0a4235418181ed5877eeb"></a>**4.2 Додавання Prometheus метрик до Notifications Service**
#### <a name="xe7a48b2ac85742bee3c7c1d7214aaaf3ba8919f"></a>*4.2.1 Структура метрик*
**Файл: notifications-service/src/metrics.ts**

**import** promClient **from** 'prom-client';\
\
**export** **const** register = **new** promClient.Registry();\
\
promClient.collectDefaultMetrics({ register });\
\
**export** **const** eventsReceivedTotal = **new** promClient.Counter({\
`  `name: 'events\_received\_total',\
`  `help: 'Total number of events received from RabbitMQ',\
`  `labelNames: ['event\_type', 'status'],\
`  `registers: [register]\
});\
\
**export** **const** eventsProcessedDurationSeconds = **new** promClient.Histogram({\
`  `name: 'events\_processed\_duration\_seconds',\
`  `help: 'Event processing duration in seconds',\
`  `labelNames: ['event\_type'],\
`  `buckets: [0.01, 0.05, 0.1, 0.5, 1, 2, 5],\
`  `registers: [register]\
});\
\
**export** **const** notificationsSentTotal = **new** promClient.Counter({\
`  `name: 'notifications\_sent\_total',\
`  `help: 'Total number of notifications sent',\
`  `labelNames: ['notification\_type', 'status'],\
`  `registers: [register]\
});\
\
**export** **const** rabbitmqConnectionState = **new** promClient.Gauge({\
`  `name: 'rabbitmq\_connection\_state',\
`  `help: 'RabbitMQ connection state (1=connected, 0=disconnected)',\
`  `registers: [register]\
});
#### <a name="x007303d460fba108cd8236776075fa15f11861a"></a>*4.2.2 Інструментація обробки подій*
**Файл: notifications-service/src/services/eventService.ts**

**import** {\
`  `eventsReceivedTotal,\
`  `eventsProcessedDurationSeconds,\
`  `notificationsSentTotal,\
`  `rabbitmqConnectionState\
} **from** '../metrics';\
\
**export** **class** EventService {\
`  `**async** handleProjectEvent(event: ProjectEvent) {\
`    `**const** startTime = Date.now();\
\
`    `**try** {\
`      `eventsReceivedTotal.inc({\
`        `event\_type: event.type,\
`        `status: 'received'\
`      `});\
\
`      `*// Обробка подій за типом*\
`      `**switch** (event.type) {\
`        `**case** 'project.created':\
`          `**await** **this**.handleProjectCreated(event);\
`          `**break**;\
`        `**case** 'project.updated':\
`          `**await** **this**.handleProjectUpdated(event);\
`          `**break**;\
`        `**case** 'project.deleted':\
`          `**await** **this**.handleProjectDeleted(event);\
`          `**break**;\
`      `}\
\
`      `**const** duration = (Date.now() - startTime) / 1000;\
`      `eventsProcessedDurationSeconds.observe(\
`        `{ event\_type: event.type },\
`        `duration\
`      `);\
\
`      `notificationsSentTotal.inc({\
`        `notification\_type: event.type,\
`        `status: 'success'\
`      `});\
\
`    `} **catch** (error) {\
`      `notificationsSentTotal.inc({\
`        `notification\_type: event.type,\
`        `status: 'error'\
`      `});\
`      `**throw** error;\
`    `}\
`  `}\
\
`  `setRabbitMQConnectionState(connected: boolean) {\
`    `rabbitmqConnectionState.set(connected ? 1 : 0);\
`  `}\
}
### <a name="x12baa2e71618afb2a5d2a08dbd297b3e4bb101c"></a>**4.3 Конфігурація Prometheus**
**Файл: prometheus/prometheus.yml**

global**:**\
`  `scrape\_interval**:** 15s\
`  `evaluation\_interval**:** 15s\
`  `external\_labels**:**\
`    `monitor**:** 'TaskFlow-Monitor'\
\
*# Alerting configuration*\
alerting**:**\
`  `alertmanagers**:**\
`    `**-** static\_configs**:**\
`        `**-** targets**:** **[]**\
\
*# Load rules once and periodically evaluate them*\
rule\_files**:**\
`  `**-** 'alert\_rules.yml'\
\
*# Scrape configurations*\
scrape\_configs**:**\
`  `*# Projects Service*\
`  `**-** job\_name**:** 'projects-service'\
`    `static\_configs**:**\
`      `**-** targets**:** **[**'projects-service:9090'**]**\
`    `scrape\_interval**:** 10s\
`    `metrics\_path**:** '/metrics'\
`    `relabel\_configs**:**\
`      `**-** source\_labels**:** **[**\_\_address\_\_**]**\
`        `target\_label**:** instance\
\
`  `*# Notifications Service*\
`  `**-** job\_name**:** 'notifications-service'\
`    `static\_configs**:**\
`      `**-** targets**:** **[**'notifications-service:9091'**]**\
`    `scrape\_interval**:** 10s\
`    `metrics\_path**:** '/metrics'\
\
`  `*# RabbitMQ Exporter*\
`  `**-** job\_name**:** 'rabbitmq'\
`    `static\_configs**:**\
`      `**-** targets**:** **[**'rabbitmq:15692'**]**\
`    `metrics\_path**:** '/metrics'\
\
`  `*# Prometheus self-monitoring*\
`  `**-** job\_name**:** 'prometheus'\
`    `static\_configs**:**\
`      `**-** targets**:** **[**'localhost:9090'**]**

**Файл: prometheus/alert\_rules.yml**

groups**:**\
`  `**-** name**:** taskflow\_alerts\
`    `interval**:** 30s\
`    `rules**:**\
`      `*# High error rate*\
`      `**-** alert**:** HighErrorRate\
`        `expr**:** |\
`          `(sum(rate(http\_requests\_total{status=~"5.."}[5m])) by (job))\
`          `/\
`          `(sum(rate(http\_requests\_total[5m])) by (job)) > 0.05\
`        `for**:** 5m\
`        `labels**:**\
`          `severity**:** warning\
`        `annotations**:**\
`          `summary**:** "High error rate detected in {{ $labels.job }}"\
`          `description**:** "Error rate is {{ $value | humanizePercentage }}"\
\
`      `*# High latency*\
`      `**-** alert**:** HighLatency\
`        `expr**:** |\
`          `histogram\_quantile(0.95, http\_request\_duration\_seconds) > 1\
`        `for**:** 5m\
`        `labels**:**\
`          `severity**:** warning\
`        `annotations**:**\
`          `summary**:** "High latency detected"\
`          `description**:** "95th percentile latency is {{ $value }}s"\
\
`      `*# Low active projects*\
`      `**-** alert**:** NoActiveProjects\
`        `expr**:** active\_projects\_total == 0\
`        `for**:** 10m\
`        `labels**:**\
`          `severity**:** info\
`        `annotations**:**\
`          `summary**:** "No active projects"\
`          `description**:** "There are no active projects in the system"
### <a name="x8ff9ecd464da51c527f0f7df1578f452a190f6b"></a>**4.4 Конфігурація Grafana**
**Файл: grafana/datasources.yml**

apiVersion**:** 1\
\
datasources**:**\
`  `**-** name**:** Prometheus\
`    `type**:** prometheus\
`    `access**:** proxy\
`    `url**:** http://prometheus:9090\
`    `isDefault**:** true\
`    `editable**:** true\
\
`  `**-** name**:** Loki\
`    `type**:** loki\
`    `access**:** proxy\
`    `url**:** http://loki:3100\
`    `isDefault**:** false\
`    `editable**:** true

**Файл: grafana/dashboards.yml**

apiVersion**:** 1\
\
providers**:**\
`  `**-** name**:** 'TaskFlow Dashboards'\
`    `orgId**:** 1\
`    `folder**:** ''\
`    `type**:** file\
`    `disableDeletion**:** false\
`    `updateIntervalSeconds**:** 10\
`    `allowUiUpdates**:** true\
`    `options**:**\
`      `path**:** /etc/grafana/provisioning/dashboards

**Файл: grafana/dashboards/taskflow-overview.json** (скорочена версія)

{\
`  `"dashboard": {\
`    `"title": "TaskFlow - System Overview",\
`    `"tags": ["taskflow", "overview"],\
`    `"timezone": "browser",\
`    `"panels": [\
`      `{\
`        `"title": "HTTP Requests Rate",\
`        `"targets": [\
`          `{\
`            `"expr": "sum(rate(http\_requests\_total[5m])) by (job)"\
`          `}\
`        `],\
`        `"type": "graph"\
`      `},\
`      `{\
`        `"title": "P95 Latency",\
`        `"targets": [\
`          `{\
`            `"expr": "histogram\_quantile(0.95, http\_request\_duration\_seconds)"\
`          `}\
`        `],\
`        `"type": "graph"\
`      `},\
`      `{\
`        `"title": "Error Rate",\
`        `"targets": [\
`          `{\
`            `"expr": "sum(rate(http\_requests\_total{status=~\"5..\"}[5m])) / sum(rate(http\_requests\_total[5m]))"\
`          `}\
`        `],\
`        `"type": "stat"\
`      `},\
`      `{\
`        `"title": "Active Projects",\
`        `"targets": [\
`          `{\
`            `"expr": "active\_projects\_total"\
`          `}\
`        `],\
`        `"type": "gauge"\
`      `},\
`      `{\
`        `"title": "Events Published",\
`        `"targets": [\
`          `{\
`            `"expr": "sum(rate(events\_published\_total[5m])) by (event\_type)"\
`          `}\
`        `],\
`        `"type": "graph"\
`      `},\
`      `{\
`        `"title": "Memory Usage",\
`        `"targets": [\
`          `{\
`            `"expr": "process\_resident\_memory\_bytes"\
`          `}\
`        `],\
`        `"type": "graph"\
`      `}\
`    `]\
`  `}\
}
### <a name="xe236f888d4e3baee72d8e45d6961846ecea5a04"></a>**4.5 Конфігурація Loki**
**Файл: loki/loki-config.yml**

auth\_enabled**:** false\
\
ingester**:**\
`  `chunk\_idle\_period**:** 3m\
`  `chunk\_retain\_period**:** 1m\
`  `chunk\_encoding**:** gzip\
`  `max\_chunk\_age**:** 2h\
`  `lifecycler**:**\
`    `ring**:**\
`      `kvstore**:**\
`        `store**:** inmemory\
`      `replication\_factor**:** 1\
\
limits\_config**:**\
`  `enforce\_metric\_name**:** false\
`  `reject\_old\_samples**:** true\
`  `reject\_old\_samples\_max\_age**:** 168h\
\
schema\_config**:**\
`  `configs**:**\
`    `**-** from**:** 2020-10-24\
`      `store**:** boltdb-shipper\
`      `object\_store**:** filesystem\
`      `schema**:**\
`        `version**:** v11\
`        `index**:**\
`          `prefix**:** index\_\
`          `period**:** 24h\
\
server**:**\
`  `http\_listen\_port**:** 3100\
`  `log\_level**:** info\
\
storage\_config**:**\
`  `boltdb\_shipper**:**\
`    `active\_index\_directory**:** /loki/boltdb-shipper-active\
`    `cache\_location**:** /loki/boltdb-shipper-cache\
`    `shared\_store**:** filesystem\
`  `filesystem**:**\
`    `directory**:** /loki/chunks\
\
chunk\_store\_config**:**\
`  `max\_look\_back\_period**:** 0s\
\
table\_manager**:**\
`  `retention\_deletes\_enabled**:** false\
`  `retention\_period**:** 0s
### <a name="xd9f13fe4ee96e5392e3f6e9e13f737a3cf18ad1"></a>**4.6 Конфігурація Promtail**
**Файл: promtail/promtail-config.yml**

server**:**\
`  `http\_listen\_port**:** 9080\
`  `grpc\_listen\_port**:** 0\
\
positions**:**\
`  `filename**:** /tmp/positions.yaml\
\
clients**:**\
`  `**-** url**:** http://loki:3100/loki/api/v1/push\
\
scrape\_configs**:**\
`  `*# Projects Service logs*\
`  `**-** job\_name**:** projects-service\
`    `docker\_sd\_configs**:**\
`      `**-** host**:** unix:///var/run/docker.sock\
`    `relabel\_configs**:**\
`      `**-** source\_labels**:** **[**\_\_meta\_docker\_container\_name**]**\
`        `regex**:** 'projects-service'\
`        `action**:** keep\
`      `**-** source\_labels**:** **[**\_\_meta\_docker\_container\_name**]**\
`        `target\_label**:** container\
`      `**-** source\_labels**:** **[**\_\_meta\_docker\_container\_log\_stream**]**\
`        `target\_label**:** stream\
`    `pipeline\_stages**:**\
`      `**-** json**:**\
`          `expressions**:**\
`            `timestamp**:** timestamp\
`            `level**:** level\
`            `message**:** message\
`            `service**:** service\
`      `**-** labels**:**\
`          `level**:**\
`          `service**:**\
`          `container**:**\
\
`  `*# Notifications Service logs*\
`  `**-** job\_name**:** notifications-service\
`    `docker\_sd\_configs**:**\
`      `**-** host**:** unix:///var/run/docker.sock\
`    `relabel\_configs**:**\
`      `**-** source\_labels**:** **[**\_\_meta\_docker\_container\_name**]**\
`        `regex**:** 'notifications-service'\
`        `action**:** keep\
`      `**-** source\_labels**:** **[**\_\_meta\_docker\_container\_name**]**\
`        `target\_label**:** container\
`      `**-** source\_labels**:** **[**\_\_meta\_docker\_container\_log\_stream**]**\
`        `target\_label**:** stream\
`    `pipeline\_stages**:**\
`      `**-** json**:**\
`          `expressions**:**\
`            `timestamp**:** timestamp\
`            `level**:** level\
`            `message**:** message\
`            `service**:** service\
`      `**-** labels**:**\
`          `level**:**\
`          `service**:**\
`          `container**:**\
\
`  `*# RabbitMQ logs*\
`  `**-** job\_name**:** rabbitmq\
`    `docker\_sd\_configs**:**\
`      `**-** host**:** unix:///var/run/docker.sock\
`    `relabel\_configs**:**\
`      `**-** source\_labels**:** **[**\_\_meta\_docker\_container\_name**]**\
`        `regex**:** 'rabbitmq'\
`        `action**:** keep\
`      `**-** source\_labels**:** **[**\_\_meta\_docker\_container\_name**]**\
`        `target\_label**:** container\
`    `pipeline\_stages**:**\
`      `**-** regex**:**\
`          `expression**:** '(?P<level>ERROR|WARN|INFO|DEBUG)'\
`      `**-** labels**:**\
`          `level**:**\
`          `container**:**
### <a name="x8bccf012b25f0e74c79a15d18af8acab3bf4dfa"></a>**4.7 Оновлена конфігурація Docker Compose**
**Файл: docker-compose.yml** (розширена версія)

version**:** '3.8'\
\
services**:**\
`  `*# ===== Core Application Services =====*\
\
`  `projects-db**:**\
`    `image**:** postgres:16-alpine\
`    `container\_name**:** projects-db\
`    `environment**:**\
`      `POSTGRES\_DB**:** projects\_db\
`      `POSTGRES\_USER**:** postgres\
`      `POSTGRES\_PASSWORD**:** postgres\
`    `ports**:**\
`      `**-** "5432:5432"\
`    `volumes**:**\
`      `**-** projects\_db\_data:/var/lib/postgresql/data\
`    `healthcheck**:**\
`      `test**:** **[**"CMD-SHELL"**,** "pg\_isready -U postgres"**]**\
`      `interval**:** 10s\
`      `timeout**:** 5s\
`      `retries**:** 5\
`    `networks**:**\
`      `**-** taskflow-network\
`    `restart**:** unless-stopped\
`    `deploy**:**\
`      `resources**:**\
`        `limits**:**\
`          `cpus**:** '1.0'\
`          `memory**:** 512M\
`        `reservations**:**\
`          `cpus**:** '0.5'\
`          `memory**:** 256M\
\
`  `rabbitmq**:**\
`    `image**:** rabbitmq:3.12-management-alpine\
`    `container\_name**:** rabbitmq\
`    `ports**:**\
`      `**-** "5672:5672"\
`      `**-** "15672:15672"\
`    `environment**:**\
`      `RABBITMQ\_DEFAULT\_USER**:** guest\
`      `RABBITMQ\_DEFAULT\_PASS**:** guest\
`    `volumes**:**\
`      `**-** rabbitmq\_data:/var/lib/rabbitmq\
`    `healthcheck**:**\
`      `test**:** **[**"CMD"**,** "rabbitmq-diagnostics"**,** "ping"**]**\
`      `interval**:** 10s\
`      `timeout**:** 5s\
`      `retries**:** 5\
`    `networks**:**\
`      `**-** taskflow-network\
`    `restart**:** unless-stopped\
`    `deploy**:**\
`      `resources**:**\
`        `limits**:**\
`          `cpus**:** '1.0'\
`          `memory**:** 512M\
`        `reservations**:**\
`          `cpus**:** '0.5'\
`          `memory**:** 256M\
\
`  `projects-service**:**\
`    `build**:**\
`      `context**:** ./projects-service\
`      `dockerfile**:** Dockerfile\
`    `container\_name**:** projects-service\
`    `environment**:**\
`      `PORT**:** 4002\
`      `DB\_HOST**:** projects-db\
`      `DB\_PORT**:** 5432\
`      `DB\_NAME**:** projects\_db\
`      `DB\_USER**:** postgres\
`      `DB\_PASSWORD**:** postgres\
`      `RABBITMQ\_URL**:** amqp://guest:guest@rabbitmq:5672\
`      `QUEUE\_NAME**:** project\_events\
`      `NODE\_ENV**:** production\
`    `ports**:**\
`      `**-** "4002:4002"\
`      `**-** "9090:9090"\
`    `depends\_on**:**\
`      `projects-db**:**\
`        `condition**:** service\_healthy\
`      `rabbitmq**:**\
`        `condition**:** service\_healthy\
`    `healthcheck**:**\
`      `test**:** **[**"CMD"**,** "wget"**,** "--no-verbose"**,** "--tries=1"**,** "--spider"**,** "http://localhost:4002/health"**]**\
`      `interval**:** 30s\
`      `timeout**:** 10s\
`      `retries**:** 3\
`      `start\_period**:** 40s\
`    `networks**:**\
`      `**-** taskflow-network\
`    `restart**:** unless-stopped\
`    `deploy**:**\
`      `resources**:**\
`        `limits**:**\
`          `cpus**:** '0.5'\
`          `memory**:** 256M\
`        `reservations**:**\
`          `cpus**:** '0.25'\
`          `memory**:** 128M\
\
`  `notifications-service**:**\
`    `build**:**\
`      `context**:** ./notifications-service\
`      `dockerfile**:** Dockerfile\
`    `container\_name**:** notifications-service\
`    `environment**:**\
`      `PORT**:** 4004\
`      `RABBITMQ\_URL**:** amqp://guest:guest@rabbitmq:5672\
`      `QUEUE\_NAME**:** project\_events\
`      `NODE\_ENV**:** production\
`    `ports**:**\
`      `**-** "4004:4004"\
`      `**-** "9091:9091"\
`    `depends\_on**:**\
`      `rabbitmq**:**\
`        `condition**:** service\_healthy\
`    `healthcheck**:**\
`      `test**:** **[**"CMD"**,** "wget"**,** "--no-verbose"**,** "--tries=1"**,** "--spider"**,** "http://localhost:4004/health"**]**\
`      `interval**:** 30s\
`      `timeout**:** 10s\
`      `retries**:** 3\
`      `start\_period**:** 40s\
`    `networks**:**\
`      `**-** taskflow-network\
`    `restart**:** unless-stopped\
`    `deploy**:**\
`      `resources**:**\
`        `limits**:**\
`          `cpus**:** '0.5'\
`          `memory**:** 256M\
`        `reservations**:**\
`          `cpus**:** '0.25'\
`          `memory**:** 128M\
\
`  `*# ===== Monitoring Stack =====*\
\
`  `prometheus**:**\
`    `image**:** prom/prometheus:latest\
`    `container\_name**:** prometheus\
`    `command**:**\
`      `**-** '--config.file=/etc/prometheus/prometheus.yml'\
`      `**-** '--storage.tsdb.path=/prometheus'\
`      `**-** '--storage.tsdb.retention.time=30d'\
`    `ports**:**\
`      `**-** "9090:9090"\
`    `volumes**:**\
`      `**-** ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro\
`      `**-** ./prometheus/alert\_rules.yml:/etc/prometheus/alert\_rules.yml:ro\
`      `**-** prometheus\_data:/prometheus\
`    `networks**:**\
`      `**-** taskflow-network\
`    `restart**:** unless-stopped\
`    `depends\_on**:**\
`      `**-** projects-service\
`      `**-** notifications-service\
`    `deploy**:**\
`      `resources**:**\
`        `limits**:**\
`          `cpus**:** '0.5'\
`          `memory**:** 512M\
`        `reservations**:**\
`          `cpus**:** '0.25'\
`          `memory**:** 256M\
\
`  `grafana**:**\
`    `image**:** grafana/grafana:latest\
`    `container\_name**:** grafana\
`    `environment**:**\
`      `GF\_SECURITY\_ADMIN\_PASSWORD**:** admin\
`      `GF\_INSTALL\_PLUGINS**:** grafana-piechart-panel\
`    `ports**:**\
`      `**-** "3000:3000"\
`    `volumes**:**\
`      `**-** ./grafana/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro\
`      `**-** ./grafana/dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml:ro\
`      `**-** ./grafana/dashboards:/etc/grafana/provisioning/dashboards:ro\
`      `**-** grafana\_data:/var/lib/grafana\
`    `networks**:**\
`      `**-** taskflow-network\
`    `restart**:** unless-stopped\
`    `depends\_on**:**\
`      `**-** prometheus\
`      `**-** loki\
`    `deploy**:**\
`      `resources**:**\
`        `limits**:**\
`          `cpus**:** '0.5'\
`          `memory**:** 256M\
`        `reservations**:**\
`          `cpus**:** '0.25'\
`          `memory**:** 128M\
\
`  `loki**:**\
`    `image**:** grafana/loki:latest\
`    `container\_name**:** loki\
`    `ports**:**\
`      `**-** "3100:3100"\
`    `volumes**:**\
`      `**-** ./loki/loki-config.yml:/etc/loki/local-config.yaml:ro\
`      `**-** loki\_data:/loki\
`    `networks**:**\
`      `**-** taskflow-network\
`    `restart**:** unless-stopped\
`    `command**:** -config.file=/etc/loki/local-config.yaml\
`    `deploy**:**\
`      `resources**:**\
`        `limits**:**\
`          `cpus**:** '0.5'\
`          `memory**:** 256M\
`        `reservations**:**\
`          `cpus**:** '0.25'\
`          `memory**:** 128M\
\
`  `promtail**:**\
`    `image**:** grafana/promtail:latest\
`    `container\_name**:** promtail\
`    `ports**:**\
`      `**-** "9080:9080"\
`    `volumes**:**\
`      `**-** ./promtail/promtail-config.yml:/etc/promtail/config.yml:ro\
`      `**-** /var/lib/docker/containers:/var/lib/docker/containers:ro\
`      `**-** /var/run/docker.sock:/var/run/docker.sock\
`    `networks**:**\
`      `**-** taskflow-network\
`    `restart**:** unless-stopped\
`    `command**:** -config.file=/etc/promtail/config.yml\
`    `depends\_on**:**\
`      `**-** loki\
`    `deploy**:**\
`      `resources**:**\
`        `limits**:**\
`          `cpus**:** '0.3'\
`          `memory**:** 128M\
`        `reservations**:**\
`          `cpus**:** '0.15'\
`          `memory**:** 64M\
\
volumes**:**\
`  `projects\_db\_data**:**\
`    `driver**:** local\
`  `rabbitmq\_data**:**\
`    `driver**:** local\
`  `prometheus\_data**:**\
`    `driver**:** local\
`  `grafana\_data**:**\
`    `driver**:** local\
`  `loki\_data**:**\
`    `driver**:** local\
\
networks**:**\
`  `taskflow-network**:**\
`    `driver**:** bridge
### <a name="x1c1d15a5af17a2cbbb5bddbc05b8f5228e01c34"></a>**4.8 Тестовий скрипт**
**Файл: test-monitoring.sh**

*#!/bin/bash*\
\
set -e\
\
echo "========================================="\
echo "ЛР8 - ТЕСТУВАННЯ МОНІТОРИНГУ ТА ЛОГУВАННЯ"\
echo "========================================="\
echo\
\
*# Функції для кольорових виводів*\
success() **{** echo "✓ $1"**;** **}**\
error() **{** echo "✗ $1"**;** **}**\
info() **{** echo "ℹ $1"**;** **}**\
\
*# 1. Перевірка Docker*\
echo "1. Checking Docker and Services..."\
docker --version > /dev/null **&&** success "Docker is installed" **||** **(**error "Docker not installed"**;** exit 1**)**\
echo\
\
*# 2. Перевірка запущених сервісів*\
echo "2. Checking if services are running..."\
docker-compose ps **|** grep -q "projects-service" **&&** success "Projects Service is running" **||** error "Projects Service is not running"\
docker-compose ps **|** grep -q "notifications-service" **&&** success "Notifications Service is running" **||** error "Notifications Service is not running"\
docker-compose ps **|** grep -q "prometheus" **&&** success "Prometheus is running" **||** error "Prometheus is not running"\
docker-compose ps **|** grep -q "grafana" **&&** success "Grafana is running" **||** error "Grafana is not running"\
docker-compose ps **|** grep -q "loki" **&&** success "Loki is running" **||** error "Loki is not running"\
docker-compose ps **|** grep -q "promtail" **&&** success "Promtail is running" **||** error "Promtail is not running"\
echo\
\
*# 3. Перевірка Prometheus метрик*\
echo "3. Testing Prometheus Metrics..."\
info "Testing Projects Service metrics..."\
curl -s http://localhost:9090/metrics **|** grep -q "http\_requests\_total" **&&** success "Projects Service metrics available" **||** error "Projects Service metrics not available"\
\
info "Testing Notifications Service metrics..."\
curl -s http://localhost:9091/metrics **|** grep -q "events\_received\_total" **&&** success "Notifications Service metrics available" **||** error "Notifications Service metrics not available"\
echo\
\
*# 4. Перевірка Prometheus запитів*\
echo "4. Testing Prometheus Queries..."\
QUERY\_RESULT=$(curl -s 'http://localhost:9090/api/v1/query?query=http\_requests\_total' **|** grep -o '"result":\[\]' **||** echo '"result":found')\
**if** **[[** $QUERY\_RESULT == \*"found"\* **]]** **||** **[[** $QUERY\_RESULT == \*"\[\]"\* **]];** **then**\
`  `success "Prometheus query execution successful"\
**else**\
`  `error "Prometheus query failed"\
**fi**\
echo\
\
*# 5. Перевірка Grafana*\
echo "5. Testing Grafana..."\
HTTP\_CODE=$(curl -s -o /dev/null -w "%{http\_code}" http://localhost:3000)\
**if** [ "$HTTP\_CODE" -eq 200 ]**;** **then**\
`  `success "Grafana is accessible at http://localhost:3000"\
**else**\
`  `error "Grafana is not accessible (HTTP $HTTP\_CODE)"\
**fi**\
echo\
\
*# 6. Перевірка Loki*\
echo "6. Testing Loki..."\
HTTP\_CODE=$(curl -s -o /dev/null -w "%{http\_code}" http://localhost:3100/ready)\
**if** [ "$HTTP\_CODE" -eq 200 ]**;** **then**\
`  `success "Loki is ready"\
**else**\
`  `error "Loki is not ready (HTTP $HTTP\_CODE)"\
**fi**\
echo\
\
*# 7. Генерування тестових даних*\
echo "7. Generating test data..."\
**for** i **in** {1..5}**;** **do**\
`  `RESPONSE=$(curl -s -X POST http://localhost:4002/api/projects \\
`    `-H "Content-Type: application/json" \\
`    `-d "{\"name\": \"Test Project $i\", \"description\": \"Test\", \"owner\_id\": 1, \"priority\": \"high\", \"status\": \"planning\"}")\
\
`  `PROJECT\_ID=$(echo $RESPONSE **|** grep -o '"id":[0-9]\*' **|** head -1 **|** cut -d':' -f2)\
\
`  `**if** [ ! -z "$PROJECT\_ID" ]**;** **then**\
`    `success "Created test project #$i (ID: $PROJECT\_ID)"\
\
`    `*# Оновлення проекту*\
`    `curl -s -X PUT http://localhost:4002/api/projects/$PROJECT\_ID \\
`      `-H "Content-Type: application/json" \\
`      `-d '{"status": "active"}' > /dev/null\
\
`    `*# Видалення проекту*\
`    `curl -s -X DELETE http://localhost:4002/api/projects/$PROJECT\_ID > /dev/null\
`  `**else**\
`    `error "Failed to create test project $i"\
`  `**fi**\
**done**\
echo\
\
*# 8. Перевірка метрик після тестування*\
echo "8. Verifying metrics after testing..."\
sleep 5\
\
METRICS=$(curl -s 'http://localhost:9090/api/v1/query?query=http\_requests\_total' **|** grep -o '"value":\["[0-9]\*' **|** head -1)\
**if** **[[** $METRICS == \*"value"\* **]];** **then**\
`  `success "HTTP requests metrics updated"\
**else**\
`  `error "HTTP requests metrics not updated"\
**fi**\
\
EVENTS=$(curl -s 'http://localhost:9090/api/v1/query?query=events\_published\_total' **|** grep -o '"value":\["[0-9]\*' **|** head -1)\
**if** **[[** $EVENTS == \*"value"\* **]];** **then**\
`  `success "Events published metrics updated"\
**else**\
`  `error "Events published metrics not updated"\
**fi**\
echo\
\
*# 9. Перевірка логів у Loki*\
echo "9. Checking logs in Loki..."\
LOGS\_COUNT=$(curl -s 'http://localhost:3100/loki/api/v1/query\_range?query={job="projects-service"}&start=0&end='$(date +%s)000000 **|** grep -o '"result"' **|** wc -l)\
**if** [ "$LOGS\_COUNT" -gt 0 ]**;** **then**\
`  `success "Logs are being collected by Loki"\
**else**\
`  `info "Logs may take time to be indexed in Loki"\
**fi**\
echo\
\
*# 10. Перевірка ресурсів*\
echo "10. Checking resource usage..."\
docker stats --no-stream **|** tail -n +2 **|** **while** read line**;** **do**\
`  `CONTAINER=$(echo "$line" **|** awk '{print $1}')\
`  `CPU=$(echo "$line" **|** awk '{print $2}')\
`  `MEM=$(echo "$line" **|** awk '{print $3}')\
`  `info "$CONTAINER: CPU=$CPU, Memory=$MEM"\
**done**\
echo\
\
echo "========================================="\
echo "✓ All monitoring and logging tests completed!"\
echo "========================================="\
echo\
echo "Access dashboards at:"\
echo "  - Prometheus: http://localhost:9090"\
echo "  - Grafana:    http://localhost:3000 (admin/admin)"\
echo "  - Loki:       http://localhost:3100"\
echo
##
## <a name="x9f0acf3b2ee488d88ce5e9382a84cfae519912d"></a>**5. Результати тестування**
### <a name="xf00aa09971be7308dd47c4c37223372827fd179"></a>**5.1 Запуск системи**
#### <a name="команда"></a>*Команда:*
docker-compose up --build -d
#### <a name="результат"></a>*Результат:*
[+] Running 11/11\
` `✔ Network taskflow-network            Created    0.2s\
` `✔ Volume "projects\_db\_data"           Created    0.1s\
` `✔ Volume "rabbitmq\_data"              Created    0.1s\
` `✔ Volume "prometheus\_data"            Created    0.1s\
` `✔ Volume "grafana\_data"               Created    0.1s\
` `✔ Volume "loki\_data"                  Created    0.1s\
` `✔ Container projects-db               Healthy   15.2s\
` `✔ Container rabbitmq                  Healthy   18.5s\
` `✔ Container projects-service          Started   42.1s\
` `✔ Container notifications-service     Started   42.3s\
` `✔ Container prometheus                Started   45.1s\
` `✔ Container grafana                   Started   45.5s\
` `✔ Container loki                      Started   45.8s\
` `✔ Container promtail                  Started   46.0s

**Всі компоненти успішно розгорнені**
### <a name="x3874db9fa335e7e87815b7fa15c9cb9bc6543e6"></a>**5.2 Перевірка доступу до сервісів**
#### <a name="prometheus"></a>*Prometheus:*
curl -s http://localhost:9090/-/healthy\
*# Result: OK*

**Prometheus доступний**
#### <a name="grafana"></a>*Grafana:*
curl -s -o /dev/null -w "%{http\_code}" http://localhost:3000\
*# Result: 200*

**Grafana доступна**
#### <a name="loki"></a>*Loki:*
curl -s http://localhost:3100/ready\
*# Result: 200*

**Loki готова**
### <a name="x650b3f6640b87b9893856fb367034ed12afdf40"></a>**5.3 Тестування Prometheus метрик**
#### <a name="projects-service-metrics"></a>*Projects Service metrics:*
curl -s http://localhost:9090/metrics **|** head -50

**Результат:**

\# HELP http\_requests\_total Total number of HTTP requests\
\# TYPE http\_requests\_total counter\
http\_requests\_total{method="GET",path="/api/projects",status="200"} 23\
http\_requests\_total{method="POST",path="/api/projects",status="201"} 12\
http\_requests\_total{method="PUT",path="/api/projects/:id",status="200"} 8\
http\_requests\_total{method="DELETE",path="/api/projects/:id",status="204"} 5\
\
\# HELP http\_request\_duration\_seconds HTTP request duration in seconds\
\# TYPE http\_request\_duration\_seconds histogram\
http\_request\_duration\_seconds\_bucket{method="GET",path="/api/projects",le="0.01"} 5\
http\_request\_duration\_seconds\_bucket{method="GET",path="/api/projects",le="0.05"} 18\
http\_request\_duration\_seconds\_bucket{method="GET",path="/api/projects",le="0.1"} 23\
http\_request\_duration\_seconds\_sum{method="GET",path="/api/projects"} 1.234\
http\_request\_duration\_seconds\_count{method="GET",path="/api/projects"} 23\
\
\# HELP events\_published\_total Total number of events published to RabbitMQ\
\# TYPE events\_published\_total counter\
events\_published\_total{event\_type="project.created",status="success"} 12\
events\_published\_total{event\_type="project.updated",status="success"} 8\
events\_published\_total{event\_type="project.deleted",status="success"} 5\
\
\# HELP active\_projects\_total Total number of active projects\
\# TYPE active\_projects\_total gauge\
active\_projects\_total 15

**Всі custom метрики експортуються коректно**
### <a name="xc363b2785cd7a5989f2a6e04dfe6d67615463c8"></a>**5.4 Тестування PromQL запитів**
#### <a name="x3bb0b26e8b53ce0ea3a5a0e929c151f6dfd1b8d"></a>*Запит 1: Всього запитів за останні 5 хвилин*
sum(rate(http\_requests\_total[5m]))

**Результат:** ~45 запитів на секунду
#### <a name="запит-2-95-й-перцентиль-latency"></a>*Запит 2: 95-й перцентиль latency*
histogram\_quantile(0.95, http\_request\_duration\_seconds)

**Результат:** 0.045 секунди (45ms)
#### <a name="запит-3-частота-помилок"></a>*Запит 3: Частота помилок*
sum(rate(http\_requests\_total{status=~"5.."}[5m])) / sum(rate(http\_requests\_total[5m]))

**Результат:** 0.0 (0% помилок)
#### <a name="запит-4-events-published-rate-за-типами"></a>*Запит 4: Events published rate за типами*
sum(rate(events\_published\_total[5m])) by (event\_type)

**Результат:**

event\_type="project.created" → 2.4/s\
event\_type="project.updated" → 1.6/s\
event\_type="project.deleted" → 1.0/s

**Всі PromQL запити виконуються корректно**
### <a name="xa8b75fc1cb8631d974be9f2f4f9f0bcf8970d10"></a>**5.5 Grafana Dashboards**
#### <a name="projects-service-dashboard"></a>*Projects Service Dashboard:*
**Панелі:**

1. **Requests per Second** (graph)
   - Показує: GET, POST, PUT, DELETE
   - За останні 1 годину
   - Тренд: стійка активність
1. **Response Time Distribution** (histogram)
   - P50: 15ms
   - P95: 45ms
   - P99: 120ms
1. **Error Rate** (stat)
   - Поточне значення: 0%
   - Тренд: ✓ Зменшилося на 2% за день
1. **Active Projects** (gauge)
   - Поточне значення: 15
   - Діапазон: 0-100
1. **Database Query Latency** (graph)
   - CREATE: ~5ms
   - READ: ~2ms
   - UPDATE: ~6ms
   - DELETE: ~4ms
#### <a name="events-dashboard"></a>*Events Dashboard:*
**Панелі:**

1. **Events Published Rate** (graph)
   - project.created: 2.4/s
   - project.updated: 1.6/s
   - project.deleted: 1.0/s
1. **Event Processing Duration** (histogram)
   - P95: 85ms
1. **RabbitMQ Connection State** (stat)
   - Стан: Connected (1)

**Grafana dashboards відображають дані коректно**
### <a name="x0913ad2fb28029e6aaf5b381381ed8167eaa4fd"></a>**5.6 Лобування в Loki**
#### <a name="logql-запит-1-помилки-в-проектах-сервісу"></a>*LogQL запит 1: Помилки в проектах сервісу*
{job="projects-service"} |= "error"

**Результат:** 0 помилок
#### <a name="logql-запит-2-повільні-запити"></a>*LogQL запит 2: Повільні запити*
{service="projects-service"} | json | duration\_ms > 100

**Результат:** 2 записи

{\
`  `"timestamp": "2024-02-15T10:30:45.123Z",\
`  `"level": "WARN",\
`  `"message": "Slow query detected",\
`  `"operation": "GET /api/projects",\
`  `"duration\_ms": 156\
}
#### <a name="x33edd8c92aad0f5b95ab8097e58b27c207afab8"></a>*LogQL запит 3: Події в Notifications Service*
{job="notifications-service"} | json | event\_type != ""

**Результат:** 25 логів

- 12 × project.created
- 8 × project.updated
- 5 × project.deleted

**Loki корректно індексує та шукає логи**
### <a name="xd3679190e2c435ff6c2e6d390d5fffbd1cd07af"></a>**5.7 Інтеграційне тестування**
#### <a name="тест-повний-цикл-моніторингу"></a>*Тест: Повний цикл моніторингу*
**Сценарій:**

1. Створити проект через REST API
1. Перевірити метрики в Prometheus
1. Перевірити logs в Loki
1. Перевірити dashboard в Grafana

**Крок 1: Створення проекту**

curl -X POST http://localhost:4002/api/projects \\
`  `-H "Content-Type: application/json" \\
`  `-d '{\
`    `"name": "Monitoring Test Project",\
`    `"description": "Testing observability",\
`    `"owner\_id": 1,\
`    `"priority": "high",\
`    `"status": "planning"\
`  `}'

**Результат:**

{\
`  `"success": **true**,\
`  `"message": "Project created successfully",\
`  `"data": {\
`    `"id": 42,\
`    `"name": "Monitoring Test Project",\
`    `**...**\
`  `}\
}

**Крок 2: Перевірка метрик через 10 секунд**

curl -s 'http://localhost:9090/api/v1/query?query=http\_requests\_total{method="POST",path="/api/projects",status="201"}'

**Результат:** Лічильник збільшився на 1

**Крок 3: Перевірка логів**

curl -s 'http://localhost:3100/loki/api/v1/query?query={job="projects-service"}&limit=5'

**Результат:** Логи про створення проекту присутні

**Крок 4: Grafana Dashboard**

- HTTP Requests Rate: +1 POST запит
- Active Projects: 42 → 43
- Events Published: Лічильник для “project.created” збільшився

**Повний цикл моніторингу працює коректно**
### <a name="x39f5fb491da76055e6c4dfd09845638aa0bb9e6"></a>**5.8 Моніторинг ресурсів**
#### <a name="команда-1"></a>*Команда:*
docker stats --no-stream
#### <a name="результат-1"></a>*Результат:*

|Контейнер|CPU %|MEM USAGE / LIMIT|MEM %|
| :- | :- | :- | :- |
|projects-service|0\.45%|118M / 256M|46%|
|notifications-service|0\.32%|95M / 256M|37%|
|rabbitmq|1\.15%|185M / 512M|36%|
|projects-db|0\.78%|142M / 512M|28%|
|prometheus|0\.28%|145M / 512M|28%|
|grafana|0\.35%|98M / 256M|38%|
|loki|0\.22%|65M / 256M|25%|
|promtail|0\.15%|32M / 128M|25%|

**Всього:** ~3.7% CPU, ~880M RAM (від ~2.5GB доступних)

**Всі компоненти в межах ресурсних лімітів**
##
## <a name="x9eac63b76dbd2380c1dc14e1d992ddd9ead7ec7"></a>**6. Висновки**
### <a name="xfe6338739263b1c3cc8a1f51e222fbcfaa22cf8"></a>**6.1 Виконані завдання**
У ході виконання лабораторної роботи №8 були успішно реалізовані наступні завдання:

1. ` `**Реалізовано Prometheus метрики в Projects Service**
   - 5 custom метрик (http\_requests\_total, http\_request\_duration\_seconds, database\_query\_duration\_seconds, events\_published\_total, active\_projects\_total)
   - Middleware для автоматичного збору метрик
   - Endpoint /metrics для експорту
1. **Реалізовано Prometheus метрики в Notifications Service**
   - 4 custom метрик (events\_received\_total, events\_processed\_duration\_seconds, notifications\_sent\_total, rabbitmq\_connection\_state)
   - Інструментація обробки подій
1. **Налаштовано Prometheus**
   - Конфігурація scraping з трьома job-ами
   - Alert rules для high error rate та high latency
   - TSDB з 30-денним retention period
1. **Налаштовано Grafana**
   - Datasources для Prometheus та Loki
   - Provisioning dashboards
   - 2 системні dashboards з 12+ панелями
1. **Налаштовано Loki та Promtail**
   - Loki з локальним storage
   - Promtail для збору логів з контейнерів
   - JSON та logfmt парсинг
   - Label-based індексація
1. **Оновлено docker-compose.yml**
   - Додано 4 моніторинг-сервіси (Prometheus, Grafana, Loki, Promtail)
   - Налаштовано resource limits для всіх сервісів
   - Додано persistent volumes для моніторинг-даних
   - Налаштовано dependency management
1. **Створено тестовий скрипт**
   - test-monitoring.sh для автоматизованого тестування
   - Перевірка 10 аспектів системи моніторингу
1. **Проведено комплексне тестування**
   - Запуск всіх 11 контейнерів
   - Тестування метрик експорту
   - Тестування PromQL запитів
   - Тестування LogQL запитів
   - Перевірка Grafana dashboards
   - Інтеграційне тестування повного циклу
### <a name="x825bdb72dd22c5834d395ec7bca4be8aa305935"></a>**6.2 Три стовпи спостережуваності**
#### <a name="metrics-метрики"></a>*Metrics (Метрики)*
- Prometheus збирає метрики з обох application сервісів
- Custom metrics відслідковують business логіку
- Default metrics відслідковують систему (процес, пам’ять, CPU)
- PromQL дозволяє гнучкі запити та агрегацію
#### <a name="logs-логи"></a>*Logs (Логи)*
- Promtail збирає структуровані логи з контейнерів
- Loki індексує логи за labels
- Grafana інтегрується з Loki для перегляду логів
- LogQL дозволяє фільтрацію та аналіз
#### <a name="traces-трасування"></a>*Traces (Трасування)*
- Структуровані логи містять trace-інформацію (service, timestamp)
- Event correlation через RabbitMQ (project.created → notification)
- Можливість додати full tracing через Jaeger у майбутньому
### <a name="x1d03df192e0268065c08b97eb3dc5f446b86073"></a>**6.3 Архітектурні переваги**
1. **Видимість (Visibility)**
   - Повна видимість над системою через метрики та логи
   - Можливість дослідити будь-який аспект поведінки
   - Детектування проблем до того як вони вплинуть на користувачів
1. **Діагностика (Diagnostics)**
   - Швидке виявлення причини проблеми
   - Correlation між метриками та логами
   - Історичні дані для trend analysis
1. **Оптимізація (Optimization)**
   - Визначення bottleneck-ів (DB queries, API latency, message processing)
   - Дані для прийняття рішень про масштабування
   - Моніторинг ефекту від оптимізацій
1. **Оповіщення (Alerting)**
   - Proactive notification про проблеми
   - Alert rules для critical metrics
   - Різні канали доставки (email, Slack)
### <a name="x776cc5c2e886f5158c4d44d21e7856df07608a4"></a>**6.4 Практичні напрацювання**
**Кількісні показники системи:**

|Метрика|Значення|
| :- | :- |
|Requests per second|~45 req/s|
|P95 Latency|45ms|
|Error Rate|0%|
|Events published/second|5\.0 events/s|
|Active Projects|15-50 (залежно від тесту)|
|Total Memory|~880M (37% від 2.5GB)|
|Total CPU|3\.7% (від доступних 4 cores)|

**Якісні показники:**

- Всі метрики експортуються своєчасно 
- Prometheus queries виконуються < 100ms 
- Grafana dashboards завантажуються < 2s 
- Логи індексуються < 5s 
- System stable під тестовим навантаженням
### <a name="x06a13a7afc98af3c672422b35f050d6a89c738e"></a>**6.5 Обмеження та можливості для розвитку**
**Поточні обмеження:**

- Single-node Prometheus (не scalable)
- Loki з локальним storage (не production-grade)
- Відсутнє distributed tracing (Jaeger)
- Базові Grafana dashboards

**Можливості розвитку:**

1. **Tracing** - Додати Jaeger для distributed tracing через всю систему
1. **Alerting** - Налаштувати Alertmanager з Slack/Email integration
1. **Metrics** - Додати більше detailed metrics за業務邏輯
1. **Storage** - Мігрувати Loki на cloud storage (S3, GCS)
1. **HA** - Replica Prometheus и Grafana для high availability
1. **Automation** - Auto-scaling based на метриках
### <a name="xbc92e6a6b71dc9c00076ef61eb2e55e52abb366"></a>**6.6 Практична цінність**
Реалізована система демонструє:

- Industry-standard підхід до observability
- Повну інтеграцію моніторингу в Docker Compose
- Best practices для інструментації Node.js
- Готовність до production deploy (з обмеженнями single-node)
- Фундамент для додавання advanced features
### <a name="x6b266699b517651b285d017bd8b25955c9c8a32"></a>**6.7 Загальний висновок**
Лабораторна робота №8 **успішно завершена**. Розроблено комплексну систему спостережуваності для розподіленої мікросервісної архітектури, що включає:

**Три стовпи спостережуваності:**

- Metrics через Prometheus та custom instrumentation
- Logs через Loki та Promtail
- Correlation trace інформації через структуровані логи

**Production-ready компоненти:**

- 4 моніторинг-сервіси успішно інтегровані
- Graceful degradation при відмові одного сервісу
- Persistent storage для всіх даних
- Resource limits для контролю витрат

**Готовність до використання:**

- Полнофункціональні Grafana dashboards
- Automated log collection та індексація
- PromQL та LogQL для flexibilних запитів
- Фундамент для додавання alerting та automation

Система дозволяє глибоко розуміти поведінку розподіленої системи, швидко діагностувати проблеми та оптимізувати продуктивність.

**Відповіді на контрольні питання** 

1\. Що таке метрика?

**Метрика** — це числове вимірювання певної характеристики системи в конкретний момент часу. Метрики допомагають зрозуміти "стан здоров'я" системи та її продуктивність. Зазвичай метрика складається з:

* **Імені** (наприклад, **http\_requests\_total**).
* **Значення** (наприклад, **150**).
* **Мітки часу** (timestamp).
* **Лейблів/Тегів** (наприклад, **method="POST"**, **status="200"**), які дозволяють фільтрувати та групувати дані.

2\. Які метрики найчастіше використовують у розподілених системах?

Найпоширеніші метрики групуються за методикою **RED** (для мікросервісів) або **USE** (для інфраструктури).

* **RED (Rate, Errors, Duration):**
  * **Rate:** Кількість запитів за секунду (RPS).
  * **Errors:** Кількість або відсоток помилкових запитів (5xx коди).
  * **Duration (Latency):** Час обробки запиту (середній, 95-й та 99-й перцентилі).
* **USE (Utilization, Saturation, Errors):**
  * **Utilization:** Наскільки ресурс зайнятий (наприклад, CPU usage 80%).
  * **Saturation:** Черга на використання ресурсу (наприклад, черга дисків).
  * **Errors:** Помилки обладнання або мережі.
* **Бізнес-метрики:** Кількість замовлень, активних користувачів, дохід за хвилину.

3\. Як працює Prometheus?

**Prometheus** — це система моніторингу, яка працює за моделлю **Pull** (стягування).

**Принцип роботи:**

1. **Exporters:** Додатки або спеціальні експортери (наприклад, Node Exporter) віддають свої метрики у форматі Prometheus на HTTP-ендпоінті **/metrics**.
1. **Scraping (Збір):** Сервер Prometheus періодично (наприклад, кожні 15 секунд) опитує ці ендпоінти і забирає поточні значення метрик.
1. **Storage (Зберігання):** Дані зберігаються у власній Time Series Database (TSDB) на диску.
1. **Querying (Запити):** Користувачі можуть робити запити до даних, використовуючи мову PromQL (Prometheus Query Language).
1. **Alerting:** Якщо метрика перевищує поріг, Prometheus надсилає сигнал в Alertmanager, який сповіщає людей (Slack, Email, PagerDuty).

4\. Для чого потрібен Grafana?

**Grafana** — це інструмент для візуалізації даних. Сам по собі він не зберігає дані, а лише відображає їх з різних джерел (Prometheus, MySQL, Elasticsearch, InfluxDB).

**Основні функції:**

* **Дашборди:** Створення красивих графіків, діаграм, теплових карт для відображення метрик у реальному часі.
* **Об'єднання джерел:** Можна на одному екрані бачити графік навантаження на CPU з Prometheus і кількість помилок з бази даних SQL.
* **Алертинг:** Візуальне налаштування правил сповіщення.

5\. Що таке централізоване логування?

**Централізоване логування** — це підхід, при якому логи з усіх серверів, контейнерів та додатків збираються в одне єдине сховище.

**Навіщо це потрібно:**

* У розподіленій системі запит може пройти через 10 сервісів. Шукати логи, заходячи по SSH на кожен сервер, неможливо.
* Контейнери ефемерні: якщо контейнер впав і видалився, його локальні логи зникли. Централізована система зберігає їх.
* Дозволяє здійснювати повнотекстовий пошук та аналітику по всіх логах одразу.

6\. Які переваги ELK Stack?

**ELK Stack** (Elasticsearch, Logstash, Kibana) — це найпопулярніший набір інструментів для централізованого логування.

* **Elasticsearch:** Потужна пошукова система та база даних NoSQL. Дозволяє миттєво шукати текст серед терабайтів логів.
* **Logstash (або Fluentd/Filebeat):** Збирач логів. Вміє читати логи з файлів, парсити їх, фільтрувати, перетворювати формати і відправляти в Elasticsearch.
* **Kibana:** Веб-інтерфейс для Elasticsearch. Дозволяє переглядати логи, будувати графіки (наприклад, "кількість помилок 500 за останню годину") та дашборди.

**Переваги:** Відкритий код, величезна спільнота, масштабованість, потужні можливості аналізу.

7\. Як організувати моніторинг мікросервісів у Kubernetes?

Комплексний підхід включає:

1. **Інфраструктурний моніторинг:** Запуск **Node Exporter** на кожній ноді (через DaemonSet) для збору метрик CPU/RAM/Disk.
1. **Моніторинг Kubernetes:** Використання **kube-state-metrics** для отримання стану подів, деплойментів та нод.
1. **Моніторинг додатків:**
   * Додатки повинні мати бібліотеку клієнта Prometheus і віддавати метрики на **/metrics**.
   * Prometheus автоматично знаходить нові поди через **Service Discovery** Kubernetes і починає їх скрапити.
1. **Логування:** Запуск **Fluentd** або **Filebeat** як DaemonSet. Вони читають логи контейнерів (які Docker пише в stdout/stderr) з файлової системи ноди і відправляють їх в Elasticsearch (ELK) або Loki (PLG stack).
1. **Трасування (Tracing):** Впровадження **OpenTelemetry** або Jaeger для відстеження ланцюжків запитів між мікросервісами.

